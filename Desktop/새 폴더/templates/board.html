<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì •ê¸€ VS Jungle - ê²Œì‹œê¸€ ì‘ì„± </title>

  <style>
    /* ì „ì²´ í˜ì´ì§€ í°íŠ¸/ì—¬ë°±/ë°°ê²½ */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }

    /* ê° ì˜ì—­(ê²Œì‹œê¸€ ì‘ì„±/ëª©ë¡/ê²€ìƒ‰/ì¸ê¸°ê¸€) ê°€ìš´ë° ì •ë ¬, í­ ì œí•œ */
    .write-section, #post-list-section, .search-section, #popular-section {
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    /* ê²Œì‹œê¸€ ì‘ì„± í¼ ë””ìì¸ */
    .write-section {
      display: flex;
      align-items: center;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      position: relative;
    }

    /* ì‚¬ìš©ì í”„ë¡œí•„(ì´ë¯¸ì§€, ë‹‰ë„¤ì„) ìŠ¤íƒ€ì¼ */
    .profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-right: 20px;
      cursor: pointer;
    }
    .profile img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #ccc;}

    /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
    .inputs { display: flex; align-items: center; gap: 10px; flex-grow: 1;}
    .inputs input { width: 40%; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px;}
    .vs-text { font-weight: bold; font-size: 18px;}
    .write-button { padding: 10px 20px; background-color: #48a868; color: white; border: none; border-radius: 5px; cursor: pointer; white-space: nowrap; font-size: 18px; min-width: 70px; min-height: 40px;}

    /* ê²Œì‹œê¸€ ì¹´ë“œ(ëª©ë¡) ìŠ¤íƒ€ì¼ */
    .post-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; display: flex; align-items: flex-start; gap: 15px; position: relative;}
    .post-profile { display: flex; flex-direction: column; align-items: center; min-width: 80px;}
    .post-profile img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #ccc; cursor: pointer;}
    .post-profile .nickname { font-size: 12px; margin-top: 5px; text-align: center; cursor: pointer;}
    .post-content { flex-grow: 1;}

    /* íˆ¬í‘œ ë²„íŠ¼, ê²°ê³¼, ë°” */
    .vote-buttons { margin-top: 8px;}
    .vote-buttons button { padding: 6px 12px; margin-right: 8px; border: none; border-radius: 4px; cursor: pointer; background-color: #48a868; color: #fff; font-size: 14px;}
    .vote-buttons button:disabled { background-color: #ccc; cursor: not-allowed;}
    .vote-buttons button.selected { background-color: #2d5a3d;}
    .vote-bar { height: 16px; background-color: #eee; border-radius: 8px; overflow: hidden; margin-top: 4px; width: 100%;}
    .bar-fill { height: 100%; background-color: #48a868; text-align: right; padding-right: 5px; color: #000; font-weight: bold; font-size: 13px; line-height: 16px; background-image: linear-gradient(90deg, #76c7a3, #48a868);}
    .vote-result-label { font-size: 14px; margin-top: 5px; margin-bottom: 5px; font-weight: bold; color: #333;}

    /* ì¢‹ì•„ìš” ì˜ì—­ */
    .like-section { margin-top: 10px; display: flex; align-items: center;}
    .like-button { background: none; border: none; font-size: 20px; cursor: pointer;}
    .like-count { color: red; font-weight: bold; margin-left: 5px;}

    /* ê²Œì‹œê¸€ ì‚­ì œ ë²„íŠ¼ ë“±(ì˜¤ë¥¸ìª½ ìœ„) */
    .post-actions { position: absolute; top: 8px; right: 8px;}
    .post-actions button { margin-left: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border: none; border-radius: 4px; background: #eee;}
    .post-actions button:hover { background: #ddd;}

    /* ëª¨ë‹¬(í”„ë¡œí•„) */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;}
    .modal-content { background: white; padding: 20px; border-radius: 10px; width: 420px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);}
    .vote-list-scroll { max-height: 250px; overflow-y: auto; padding-right: 8px; margin-top: 10px; border: 1px solid #eee; border-radius: 6px;}
    .vote-list-scroll::-webkit-scrollbar { width: 6px;}
    .vote-list-scroll::-webkit-scrollbar-thumb { background-color: #aaa; border-radius: 3px;}
    .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer;}
    .close:hover { color: black;}

    /* ê²€ìƒ‰, ì¸ê¸°ê¸€, ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ë“± */
    .search-section { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;}
    #popular-section { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;}
    .popular-card { background: #fff9e6; border-left: 4px solid #d4a853; padding: 12px; margin-bottom: 10px; border-radius: 4px;}
    .vote-history-card { border: 1px solid #ddd; border-radius: 10px; background: #fff; padding: 12px 16px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.05);}
    .vote-history-content { display: flex; justify-content: space-between; align-items: center;}
    .vote-history-content .option { padding: 10px; border-radius: 8px; flex: 1; text-align: center; background: #f3f3f3; margin: 0 8px; font-weight: bold; color: #555; transition: all 0.2s ease;}
    .vote-history-content .option.selected { background: #4caf50; color: white; transform: scale(1.05);}
    .vote-history-content .vs { color: #999; font-size: 14px;}
    .logout-btn { position: absolute; top: 30px; right: 35px; padding: 8px 18px; background: #48a868; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: bold; z-index: 10;}
  </style>
</head>

<body>

  <!-- [í—¤ë”] ì„œë¹„ìŠ¤ëª…ê³¼ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ -->
  <div style="max-width:800px; margin:40px auto 20px auto; display:flex; align-items:center; justify-content:space-between;">
    <div style="flex:1; text-align:center;">
      <h1 style="margin:0; font-size:32px; color:#2d2d2d;">ì •ê¸€ VS Jungle</h1>
    </div>
    <div style="flex-shrink:0;">
      <button onclick="logout()" class="logout-btn">
        ë¡œê·¸ì•„ì›ƒ
      </button>
    </div>
  </div>

  <!-- [í”Œë˜ì‹œ ë©”ì„¸ì§€] ì•Œë¦¼(ê²½ê³ , ì•ˆë‚´) -->
  {% with messages = get_flashed_messages() %}
  {% if messages %}
    <script>
      alert("{{ messages[0] }}");
    </script>
  {% endif %}
  {% endwith %}

  <!-- [ê²Œì‹œê¸€ ì‘ì„± í¼] ì„ íƒì§€ 2ê°œ, ìµëª…ì²´í¬ -->
  <form action="{{ url_for('board_page') }}" method="POST" style="display: flex; align-items: center;" class="write-section">
    <div class="profile" onclick="openProfileModal(currentUser ? currentUser._id : null)">
      <img id="user-profile-img" src="/static/default-profile.png" alt="í”„ë¡œí•„ ì´ë¯¸ì§€" />
      <span id="nickname-display">{{ session.get('username') }}</span>
    </div>
    <div class="inputs">
      <input type="text" name="option1" id="option1" placeholder="ì²« ë²ˆì§¸ ì„ íƒì§€" required />
      <span class="vs-text">VS</span>
      <input type="text" name="option2" id="option2" placeholder="ë‘ ë²ˆì§¸ ì„ íƒì§€" required />
      <button type="submit" class="write-button" style="margin-left: 10px;">ì‘ì„±</button>
    </div>
    <!-- â­ ë³€ê²½: ìµëª… ì²´í¬ë°•ìŠ¤ & ìœ„ì¹˜ ì´ë™ (B Only) -->
    <div style="margin-top: 8px; text-align: right;">
      <label style="font-size: 13px;">
        <input type="checkbox" name="is_anonymous" value="1" style="vertical-align: middle; margin-right: 2px;" />
        ìµëª…
      </label>
    </div>
  </form>

  <!-- [ê²€ìƒ‰ ì˜ì—­] ì„ íƒì§€, ì‘ì„±ìëª…, ì „ì²´ ë“±ìœ¼ë¡œ ê²Œì‹œê¸€ í•„í„° -->
  <div class="search-section">
    <form method="get" action="{{ url_for('board_page') }}" style="display: flex; gap: 10px; align-items: center;">
      <select name="type" style="padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
        <option value="all" {% if search_type=='all' %}selected{% endif %}>ì „ì²´</option>
        <option value="option1" {% if search_type=='option1' %}selected{% endif %}>ì„ íƒì§€1</option>
        <option value="option2" {% if search_type=='option2' %}selected{% endif %}>ì„ íƒì§€2</option>
        <option value="writer" {% if search_type=='writer' %}selected{% endif %}>ì‘ì„±ì</option>
      </select>
      <input type="text" name="query" value="{{ search_query or '' }}" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px;" />
      <button type="submit" style="padding: 8px 16px; background: #48a868; color: white; border: none; border-radius: 4px; cursor: pointer;">ê²€ìƒ‰</button>
      <a href="{{ url_for('board_page') }}">
        <button type="button" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">ì „ì²´ë³´ê¸°</button>
      </a>

      <!-- ì¢‹ì•„ìš” ê²Œì‹œê¸€ í•„í„°ë§ -->
       <label style="margin-left:15px;">
          <input type="checkbox" id="filterLiked"
                 name="filterLiked" value="1"
                 {% if request.args.get('filterLiked', '0') == '1' %}checked{% endif %}>
          ì¢‹ì•„ìš”
       </label>

    </form>
  </div>

  <!-- [ì¸ê¸° ê²Œì‹œë¬¼ ì˜ì—­] ì¢‹ì•„ìš” ë§ì€ 1ê°œë§Œ ì¹´ë“œë¡œ ë³´ì—¬ì¤Œ -->
  <div id="popular-section">
    <h3 style="margin-bottom: 15px; color: #d4a853;">ğŸ† ì¸ê¸° ê²Œì‹œë¬¼</h3>
    <div id="popular-container"></div>
  </div>

  <!-- [ê²Œì‹œê¸€ ëª©ë¡] ê²Œì‹œíŒ ì „ì²´ ê¸€ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
  <div id="post-list-section">
    {% for post in cards %}
    <div class="post-card">
      <!-- â­ ìµëª… í”„ë¡œí•„/ë‹‰ë„¤ì„ ë¶„ê¸° -->
      <div class="post-profile">
        {% if post.is_anonymous %}
          <!-- ìµëª… í”„ë¡œí•„ì¼ ë•Œ í´ë¦­ ë¶ˆê°€ -->
          <img src="/static/default-profile.png" alt="ê¸°ë³¸ í”„ë¡œí•„" style="cursor:pointer;" onclick="openProfileModal('ìµëª…')" />
          <p class="nickname" style="cursor:pointer;" onclick="openProfileModal('ìµëª…')">ìµëª…</p>
        {% else %}
          <img src="/profile_image/{{ post.writer_id }}" alt="í”„ë¡œí•„" onclick="openProfileModal('{{ post.writer_id }}')" />
          <p class="nickname" onclick="openProfileModal('{{ post.writer_id }}')">{{ post.writer }}</p>
        {% endif %}
      </div>
      <div class="post-content">
        <!-- ê²Œì‹œê¸€ ì„ íƒì§€ í‘œì‹œ -->
        <p><strong>{{ post.option1 }}</strong> VS <strong>{{ post.option2 }}</strong></p>
        <!-- ì‘ì„±ì¼ì‹œ -->
        <p style="font-size:12px;color:gray;">
          {{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') }}
        </p>
        <!-- íˆ¬í‘œ ë²„íŠ¼ -->
        <div class="vote-buttons">
          <button onclick="submitVote('{{ post._id }}', 1)">{{ post.option1 }} </button>
          <button onclick="submitVote('{{ post._id }}', 2)">{{ post.option2 }} </button>
        </div>
        <!-- íˆ¬í‘œ ê²°ê³¼ ì‹œê°í™” -->
        {% set total_votes = (post.result1 or 0) + (post.result2 or 0) %}
        {% if total_votes > 0 %}
        {% set percent1 = ((post.result1 or 0) / total_votes * 100) | round(1) %}
        {% set percent2 = ((post.result2 or 0) / total_votes * 100) | round(1) %}
        <div class="vote-result-label">{{ post.option1 }}: {{ percent1 }}% ({{ post.result1 }}ëª…)</div>
        <div class="vote-bar">
          <div class="bar-fill" style="width: {{ percent1 }}%">{{ percent1 }}%</div>
        </div>
        <div class="vote-result-label">{{ post.option2 }}: {{ percent2 }}% ({{ post.result2 }}ëª…)</div>
        <div class="vote-bar">
          <div class="bar-fill" style="width: {{ percent2 }}%">{{ percent2 }}%</div>
        </div>
        {% else %}
        <p style="color: gray; margin-top: 10px;">ì•„ì§ íˆ¬í‘œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
        <!-- ì¢‹ì•„ìš”(í•˜íŠ¸) -->
        <div class="like-section">
          <button onclick="toggleLike('{{ post._id }}')">â¤ï¸ {{ post.likes or 0 }}</button>
        </div>
        <!-- ëŒ“ê¸€ í¼ì¹˜ê¸° ë²„íŠ¼ -->
        <div style="text-align: center; margin-top: 10px;">
          <button onclick="document.getElementById('details-{{ post._id }}').style.display = 'block'"
            style="padding: 10px 20px; background-color: #ffffff; color: black; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">
            + í¼ì³ë³´ê¸°
          </button>
        </div>
        <!-- ğŸ’¬ ëŒ“ê¸€ ë³´ê¸° ì˜ì—­ -->
        <div id="details-{{ post._id }}"
          style="display: none; margin-top: 15px; padding: 20px; background: #f0f9f4; border: 2px solid #b6e2c2; border-radius: 8px; max-height: 400px; overflow-y: auto;">
          <h4 style="margin-bottom: 10px;">ğŸ’¬ ëŒ“ê¸€</h4>
          <!-- ë‹«ê¸° ë²„íŠ¼ -->
          <div style="text-align: right;">
            <button onclick="document.getElementById('details-{{ post._id }}').style.display = 'none'"
              style="border: none; background: none; font-size: 20px; cursor: pointer;">âœ–</button>
          </div>
          <div id="comments-{{ post._id }}">
            {% if post.comments %}
              {% for c in post.comments %}
                <p><strong>
                  {% if c.is_anonymous %}
                    <span style="cursor: pointer;" onclick="openProfileModal('ìµëª…')">ìµëª…</span>
                  {% else %}
                    <span style="cursor: pointer;" onclick="openProfileModal('{{ c.writer_id }}')">{{ c.nickname }}</span>
                  {% endif %}
                </strong>: {{ c.content }}

                <!-- ğŸ”¥ ì‚­ì œ ë²„íŠ¼ ì¡°ê±´: writer_idê°€ í˜„ì¬ ë¡œê·¸ì¸í•œ user_idì™€ ê°™ì„ ë•Œë§Œ -->
                {% if session.get('user_id') == c.writer_id %}
                  <button onclick="deleteComment('{{ post._id }}', '{{ c._id }}')">ì‚­ì œ</button>
                {% endif %}
                </p>
              {% endfor %}
            {% else %}
              <p style="color: gray;">ëŒ“ê¸€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
            {% endif %}
          </div>


          <!-- ëŒ“ê¸€ ì‘ì„± ì…ë ¥ì°½ (ìµëª… ì²´í¬í¬í•¨) -->
          <div style="margin-top: 15px;">
            <input type="text" id="comment-input-{{ post._id }}" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"
              style="width: 100%; padding: 10px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc;">
            <label style="margin-left: 8px;">
              <!-- â­ï¸ëŒ“ê¸€ ìµëª… ì²´í¬ ë°•ìŠ¤ (B Only) -->
              <input type="checkbox" id="comment-anon-{{ post._id }}" value="1" /> ìµëª…
            </label>
            <button onclick="submitComment('{{ post._id }}')"
              style="margin-top: 10px; padding: 8px 16px; background-color: #48a868; color: white; border: none; border-radius: 5px; cursor: pointer;">
              ëŒ“ê¸€ ë“±ë¡
            </button>
          </div>
        </div>
        <!-- ë³¸ì¸ë§Œ ì‚­ì œ ê°€ëŠ¥ (user_id ì²´í¬) -->
        {% if session.get('user_id') == post.writer_id %}
          <div class="post-actions">
            <button type="button" onclick="deletePost('{{ post._id }}')">ì‚­ì œ</button>
          </div>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- [í˜ì´ì§€ë„¤ì´ì…˜] ì—¬ëŸ¬ í˜ì´ì§€ ê²Œì‹œê¸€ ì´ë™ -->
  <div style="text-align: center; margin-top: 20px;">
    {% for p in range(1, total_pages + 1) %}
    {% if p == page %}
    <strong>[{{ p }}]</strong>
    {% else %}
    <a href="{{ url_for('board_page', page=p) }}">[{{ p }}]</a>
    {% endif %}
    {% endfor %}
  </div>

  <!-- [í”„ë¡œí•„ ëª¨ë‹¬] ì‚¬ìš©ì ì •ë³´/ìµœê·¼íˆ¬í‘œ í‘œì‹œ ëª¨ë‹¬ -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeProfileModal()">&times;</span>
      <h2>ì‚¬ìš©ì í”„ë¡œí•„</h2>
      <div style="text-align: center; margin-bottom: 20px;">
        <img id="modal-profile-img" src="/static/default-profile.png" alt="í”„ë¡œí•„" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #ccc;">
      </div>
      <div id="modal-content">
        <p><strong>ë³„ëª…:</strong> <span id="modal-nickname"></span></p>
        <p><strong>ë‚˜ì´:</strong> <span id="modal-age"></span></p>
        <p><strong>ì†Œê°œ:</strong> <span id="modal-intro"></span></p>
        <hr />
        <h4>ğŸ“Š ìµœê·¼ íˆ¬í‘œí•œ ê²Œì‹œë¬¼</h4>
        <div id="modal-vote-list" class="vote-list-scroll"></div>
      </div>
    </div>
  </div>

  <!-- [JS] ì£¼ìš” ê¸°ëŠ¥ (íˆ¬í‘œ, ì¢‹ì•„ìš”, ëŒ“ê¸€, ì‚­ì œ, ëª¨ë‹¬ ë“±) -->
  <script>
    // í† í°/ìœ ì € ì •ë³´
    const token = localStorage.getItem('access_token');
    let currentUser = null;

    // ìƒˆë¡œê³ ì¹¨(ì „ì²´ ê¸€ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°)
    function fetchPosts() { window.location.reload(); }

    // ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    function loadCurrentUser() {
      fetch('/user/me', { headers: { 'Authorization': `Bearer ${token}` } })
        .then(res => res.json())
        .then(user => {
          currentUser = user;
          document.getElementById('nickname-display').textContent = user.nickname;
          if (user.has_profile_image) document.getElementById('user-profile-img').src = `/profile_image/${user._id}`;
        })
        .catch(err => console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', err));
    }

    // í”„ë¡œí•„ ëª¨ë‹¬ ì—´ê¸° (ìµëª… ì˜ˆì™¸ì²˜ë¦¬)
    function openProfileModal(userId = null) {
      const myId = currentUser ? currentUser._id : null;
      const targetUserId = userId || myId;
      if (!targetUserId || targetUserId === "ìµëª…" || targetUserId === "" || targetUserId == null) {
        alert("ìµëª… ì‚¬ìš©ìëŠ” í”„ë¡œí•„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }
      fetch(`/user/${targetUserId}`, { headers: { 'Authorization': `Bearer ${token}` } })
        .then(res => res.json())
        .then(user => {
          document.getElementById('modal-nickname').textContent = user.nickname;
          document.getElementById('modal-age').textContent = user.age || 'ë¹„ê³µê°œ';
          document.getElementById('modal-intro').textContent = user.intro || 'ì†Œê°œ ì—†ìŒ';
          if (user.has_profile_image) document.getElementById('modal-profile-img').src = `/profile_image/${user._id}`;
          else document.getElementById('modal-profile-img').src = '/static/default-profile.png';
          document.getElementById('profileModal').style.display = 'flex';
          // ìµœê·¼ íˆ¬í‘œ ì¹´ë“œí˜• í‘œì‹œ
          fetch(`/user/${targetUserId}/recent-votes`, { headers: { 'Authorization': `Bearer ${token}` } })
            .then(res => res.json())
            .then(data => {
              const list = document.getElementById('modal-vote-list');
              list.innerHTML = '';
              if (!data.votes || data.votes.length === 0) {
                list.innerHTML = '<div style="padding:10px;">ìµœê·¼ íˆ¬í‘œí•œ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
              }
              data.votes.forEach(v => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'vote-history-card';
                const voted = v.voted;
                const selected1 = voted == 1 || voted == '1';
                const selected2 = voted == 2 || voted == '2';
                const check1 = selected1 ? 'âœ”ï¸ ' : '';
                const check2 = selected2 ? 'âœ”ï¸ ' : '';
                cardDiv.innerHTML = `
                  <div class="vote-history-content">
                    <div class="option ${selected1 ? 'selected' : ''}">${check1}${v.option1} (${v.votes1 || 0})</div>
                    <div class="vs">VS</div>
                    <div class="option ${selected2 ? 'selected' : ''}">${check2}${v.option2} (${v.votes2 || 0})</div>
                  </div>
                `;
                list.appendChild(cardDiv);
              });
            });
        });
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }

    // íˆ¬í‘œí•˜ê¸° ê¸°ëŠ¥
    function submitVote(postId, option) {
      fetch(`/cards/${postId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ option: String(option) })
      })
        .then(res => { if (!res.ok) throw new Error("íˆ¬í‘œ ì‹¤íŒ¨"); return res.json(); })
        .then(data => { fetchPosts(); loadPopularPost(); })
        .catch(err => { alert('íˆ¬í‘œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); });
    }

    // ì¢‹ì•„ìš” ê¸°ëŠ¥
    function toggleLike(postId) {
      fetch(`/cards/${postId}/like`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(res => { if (!res.ok) throw new Error("ì¢‹ì•„ìš” ì‹¤íŒ¨"); return res.json(); })
        .then(data => { fetchPosts(); loadPopularPost(); })
        .catch(err => { alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); });
    }

    // ëŒ“ê¸€ ë“±ë¡(ì‘ì„±)
    function submitComment(cardId) {
      const token = localStorage.getItem('access_token');
      const comment = document.getElementById(`comment-input-${cardId}`).value;
      const isAnonBox = document.getElementById(`comment-anon-${cardId}`);
      const isAnon = isAnonBox ? isAnonBox.checked : false;
      if (!comment) { alert("ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”."); return; }
      fetch(`/cards/${cardId}/comment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
        body: JSON.stringify({ comment, is_anonymous: isAnon ? "1" : "0" })
      })
        .then(response => {
          if (response.ok) {
            document.getElementById(`comment-input-${cardId}`).value = '';
            fetchComments(cardId);
          } else {
            return response.json().then(data => { throw new Error(data.msg || "ëŒ“ê¸€ ë“±ë¡ ì‹¤íŒ¨"); });
          }
        })
        .catch(err => { alert(err.message); });
    }

    // ëŒ“ê¸€ ìƒˆë¡œê³ ì¹¨(ì „ì²´ ë¶ˆëŸ¬ì˜¤ê¸°)
    function fetchComments(cardId) {
      fetch(`/cards/${cardId}/comments`, {
        headers: { 'Authorization': `Bearer ${token}` }
      })
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById(`comments-${cardId}`);
          container.innerHTML = data.comments.map(c =>
            `<p><strong>${c.is_anonymous ? 'ìµëª…' : c.nickname}</strong>: ${c.content}</p>`
          ).join('');
        });
    }

    function deleteComment(cardId, commentId) {
      if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      fetch(`/cards/${cardId}/comment/${commentId}/delete`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      })
        .then(res => {
          if (!res.ok) throw new Error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨');
          alert('ëŒ“ê¸€ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
          fetchComments(cardId);
        })
        .catch(err => alert(err.message));
    }


    // ì¸ê¸° ê²Œì‹œë¬¼ ë¶ˆëŸ¬ì˜¤ê¸°
    function loadPopularPost() {
      fetch('/popular-card', { headers: { 'Authorization': `Bearer ${token}` } })
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('popular-container');
          if (data.card) {
            const post = data.card;
            const profileImgSrc = `/profile_image/${post.writer_id}`;
            container.innerHTML = `
              <div class="popular-card">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <img src="${profileImgSrc}" alt="í”„ë¡œí•„" style="width: 40px; height: 40px; border-radius: 50%; cursor: pointer;" onclick="openProfileModal('${post.writer_id}')">
                  <span style="cursor: pointer;" onclick="openProfileModal('${post.writer_id}')">${post.writer}</span>
                </div>
                <p><strong>${post.option1}</strong> VS <strong>${post.option2}</strong></p>
                <div style="font-size: 12px; color: #666;">
                  â‘  ${post.votes1} í‘œ | â‘¡ ${post.votes2} í‘œ | â¤ï¸ ${post.likes} ì¢‹ì•„ìš”
                </div>
              </div>
            `;
          } else {
            container.innerHTML = '<p style="text-align: center; color: #666;">ì•„ì§ ì¸ê¸° ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
          }
        });
    }

    // ë¡œê·¸ì•„ì›ƒ ê¸°ëŠ¥
    function logout() {
      fetch('/logout').then(() => {
        alert('ë¡œê·¸ì•„ì›ƒ ì„±ê³µ!');
        window.location.href = '/login';
      });
    }

    // ê²Œì‹œê¸€ ì‚­ì œ (ë³¸ì¸ë§Œ)
    function deletePost(postId) {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      fetch(`/cards/${postId}/delete`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      })
      .then(res => {
        if (!res.ok) throw new Error('ì‚­ì œ ì‹¤íŒ¨');
        alert('ì‚­ì œí–ˆìŠµë‹ˆë‹¤.');
        fetchPosts();
      })
      .catch(err => alert(err.message));
    }

    // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function (event) {
      const modal = document.getElementById('profileModal');
      if (event.target === modal) { modal.style.display = 'none'; }
    }

    // í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", function () {
      loadCurrentUser();
      loadPopularPost();
    });

  </script>
</body>
</html>


